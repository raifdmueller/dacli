:jbake-title: Building Block View
:jbake-type: page_toc
:jbake-status: published
:jbake-menu: arc42
:jbake-order: 5
:filename: /chapters/05_building_block_view.adoc
ifndef::imagesdir[:imagesdir: ../../images]

:toc:

[[section-building-block-view]]
== Building Block View

This chapter describes the static decomposition of the system into its key building blocks. We use the C4 model to illustrate the structure at different levels of detail.

=== Level 2: System Containers

The dacli system provides two interfaces: a CLI tool for direct command-line usage and an MCP server for LLM integration. The file system serves as the system's database (see ADR-001).

[plantuml, container-overview, svg]
----
@startuml
!include <C4/C4_Container>
LAYOUT_WITH_LEGEND()

title Container diagram for dacli

Person(user, "Developer / Architect", "Uses the system via CLI or MCP client.")

System_Boundary(dacli_system, "dacli") {
    Container(cli, "CLI Tool", "Python, Click", "Provides command-line access to all documentation tools (dacli).")
    Container(mcp, "MCP Server", "Python, FastMCP", "Provides MCP-compliant tools for LLM integration (dacli-mcp).")
    ContainerDb(file_system, "Documentation Files", "File System", "AsciiDoc and Markdown files. Single source of truth (ADR-001).")
}

Rel(user, cli, "Executes commands", "Shell")
Rel(user, mcp, "Sends tool calls via MCP Client", "stdio")
Rel(cli, file_system, "Reads/Writes", "File I/O")
Rel(mcp, file_system, "Reads/Writes", "File I/O")
@enduml
----

=== Level 3: Components of the MCP Server

We now zoom into the `MCP Server` container. It is composed of several components, each with a distinct responsibility.

[plantuml, component-detail-api, svg]
----
@startuml
!include <C4/C4_Component>
LAYOUT_WITH_LEGEND()

title Component diagram for MCP Server

Container_Boundary(mcp_boundary, "MCP Server [Container: Python, FastMCP]") {
    Component(mcp_tools, "MCP Tools", "FastMCP", "Exposes tools for navigation, search, manipulation via MCP protocol.")
    Component(services_mcp, "Service Layer", "Python", "Shared business logic: content, validation, metadata services.")
    Component(parser_mcp, "Document Parsers", "Python", "Parses AsciiDoc/Markdown files, resolves includes, builds AST with line numbers.")
    Component(index_mcp, "Structure Index", "Python", "In-memory hierarchical structure for fast lookups.")
    Component(fs_handler_mcp, "File System Handler", "Python", "Performs atomic read/write operations with backup strategy (ADR-004).")
}

ContainerDb(file_system, "Documentation Files", "File System", "AsciiDoc and Markdown files.")

Rel(mcp_tools, services_mcp, "Delegates to")
Rel(mcp_tools, index_mcp, "Queries structure and elements")
Rel(services_mcp, fs_handler_mcp, "Reads/Writes content via")
Rel(index_mcp, parser_mcp, "Is built by during initialization")
Rel(parser_mcp, fs_handler_mcp, "Reads files via")
Rel(fs_handler_mcp, file_system, "Reads/Writes", "File I/O")
@enduml
----

=== Level 3: Components of the CLI

The CLI tool (`dacli`) provides the same documentation operations as the MCP Server, accessible via command-line. It shares the core components (parsers, index, file handler) and adds a presentation layer for terminal output.

[plantuml, component-detail-cli, svg]
----
@startuml
!include <C4/C4_Component>
LAYOUT_WITH_LEGEND()

title Component diagram for CLI Tool

Container_Boundary(cli_boundary, "CLI Tool [Container: Python, Click]") {
    Component(click_cmds, "Click Commands", "Python, Click", "Command groups: Navigation, Search, Manipulation, Meta-Information.")
    Component(cli_ctx, "CliContext", "Python", "Holds shared state: index, file handler, parsers, output format.")
    Component(formatter, "Output Formatter", "Python", "Formats results as JSON, YAML, or human-readable text.")
    Component(services_cli, "Service Layer", "Python", "Shared business logic: content, validation, metadata services.")
    Component(parser_cli, "Document Parsers", "Python", "Parses AsciiDoc/Markdown files, resolves includes, builds AST with line numbers.")
    Component(index_cli, "Structure Index", "Python", "In-memory hierarchical structure for fast lookups.")
    Component(fs_handler_cli, "File System Handler", "Python", "Performs atomic read/write operations with backup strategy (ADR-004).")
}

ContainerDb(file_system, "Documentation Files", "File System", "AsciiDoc and Markdown files.")

Rel(click_cmds, cli_ctx, "Receives shared state from")
Rel(click_cmds, services_cli, "Delegates to")
Rel(click_cmds, formatter, "Formats output via")
Rel(services_cli, index_cli, "Queries structure and elements")
Rel(services_cli, fs_handler_cli, "Reads/Writes content via")
Rel(cli_ctx, index_cli, "Initializes on startup")
Rel(cli_ctx, parser_cli, "Parses files with")
Rel(index_cli, parser_cli, "Is built by during initialization")
Rel(parser_cli, fs_handler_cli, "Reads files via")
Rel(fs_handler_cli, file_system, "Reads/Writes", "File I/O")
@enduml
----

.CLI Command Groups
[cols="1,2"]
|===
| Group | Commands

| **Navigation**
| `structure`, `section`, `sections-at-level`

| **Search & Elements**
| `search`, `elements`

| **Manipulation**
| `update`, `insert`

| **Meta-Information**
| `metadata`, `validate`, `dependencies`
|===

=== Document Parser Architecture

Both the MCP Server and CLI containers use the same "Document Parsers" component. Internally, it contains two independent parser implementations with distinct architectures, sharing utility functions via `parser_utils`.

.Parser Comparison
[cols="1,2,2"]
|===
| Aspect | AsciiDoc Parser | Markdown Parser

| **File Discovery**
| Follows `include::[]` directives from root document
| Scans folder hierarchy (`index.md` first, then alphabetic)

| **Structure Source**
| Heading levels (`=`, `==`, `===`, ...)
| Heading levels (`#`, `##`, `###`, ...) plus folder nesting

| **Include Support**
| Full recursive resolution with cycle detection
| None (folder hierarchy replaces includes)

| **Metadata**
| Document attributes (`:key: value`)
| YAML frontmatter

| **Unique Feature**
| Attribute substitution in paths, source mapping across includes
| Numeric prefix sorting (`10-intro.md` before `20-setup.md`)
|===

Key classes:

* **AsciidocStructureParser** — Parses `.adoc` files. Delegates to an include resolver (recursive, with circular-include detection) and an attribute handler (`:attr:` substitution in text and include paths).
* **MarkdownStructureParser** — Parses `.md` files by scanning folder hierarchies. Supports YAML frontmatter for metadata.
* **parser_utils** — Shared functions: `slugify`, `strip_doc_extension`, `find_section_by_path`, `collect_all_sections`.

For the internal structure of each parser (Level 4: Code), see the component specifications:

* link:../../spec/05_asciidoc_parser.adoc[AsciiDoc Parser Specification] — includes state machine diagram, include resolution algorithm, and data models
* link:../../spec/04_markdown_parser.adoc[Markdown Parser Specification] — includes state machine diagram, folder hierarchy rules, and data models

=== Component Responsibilities

The following table maps components to the MCP tools:

.Component to MCP Tool Mapping
[cols="2,3,2"]
|===
| Component | Responsibility | MCP Tools

| **MCP Tools / CLI Commands**
| Expose all functionality via MCP protocol or command line
| get_structure, get_section, get_sections_at_level, search, get_elements, get_metadata, validate_structure, update_section, insert_content, get_dependencies

| **Service Layer**
| Shared business logic for content manipulation, validation, metadata
| (Internal - used by both CLI and MCP)

| **Document Parsers**
| Parse AsciiDoc/Markdown, resolve includes, track line numbers
| (Internal - used during initialization)

| **Structure Index**
| In-memory index for fast lookups of sections and elements
| (Internal - supports all read operations)

| **File System Handler**
| Atomic file read/write operations with backup strategy
| (Internal - supports write operations, ADR-004)
|===

=== Data Models

The following core data models are used across components (see API Specification for details):

* **SectionLocation** - File path and line range for a section
* **Section** - Hierarchical document section with metadata
* **Element** - Typed content element (table, code, diagram)
* **SearchResult** - Search hit with context and relevance score
* **Metadata** - Document or section metadata
* **ValidationResult** - Structure validation outcome
